---
title: 页面卡顿分析
date: 2018-09-18 20:10:58
tags: [前端, node, 服务器]
---

&emsp;&emsp;

<!--more-->

# 背景

&emsp;&emsp;客服工作台接入层一直跑在node7环境中，虽说我本地开发调试一直用的node10，也从来没有出过问题。直到突然有一天早上刚到公司坐下，测试就说独立测试环境工作台无法访问了（昨天不还好好的吗？我啥也没干啊）。然后自己试了一下，果然访问不了了，然后跑到测试机上去找错误日志。

![](/images/33.jpg)

&emsp;&emsp; 大意呢就是某个依赖包找不到。具体的原因[这篇文章有简单说明](https://futu.lexiangla.com/teams/web/docs/5f4a133c932911e98d0a0a58ac130473?lxref=search-company&company_from=futu)。一句话概括就是：安装node_package的时候是node7环境，线上运行的时候变node10了，导致了这个错误。

&emsp;&emsp; 好，知道原因，开撸。按照文中的解决方案一，一路撸下来，很快，独立测试环境的问题得以解决。当时由于在忙别的工作，也没想预发布和正式环境是否都OK啊。直到需要发布代码的时候，发现预发布直接报错（因为预发布的walle发布配置没有改）；找leader改之后，发布成功，但是代码却报错了。。。

&emsp;&emsp; 去机器上一看，一样的错误；一看预发布node版本才知道是node7，因为现在已经改成发布机按照依赖包的时候是按照node10去安装的，怎么办？？ 之前才为了能够发布到node10到机器上，现在肯定是不能再改回去兼容node7了（方法倒是有，看上面那篇文章最后一部分，但是这种方式只能用fork模式，也就是不能利用多核cpu的能力，我肯定是不能接受的）；后来找八哥请教了一下之后，统一升级到node10看来是无法避免的了。升呗～～

&emsp;&emsp;然后自己整理了一份升级文档，大概如下

    升级原因：
    1. 升级node10的目的主要是为了解决不同node版本导致的程序错误。
    2. 从长远来看，升级node10是必然的（node7不是一个稳定的版本，已经不维护了）。

    现状：
    1. 目前工作台部署在172.28.0.208和172.28.0.111两台机器上，通过vip(172.28.0.81)进行访问，两台机器上都是使用对node7.10.0版本。
    2. 172.28.0.208目前已经部署的项目有：客服工作台、 知识库、 监控平台
    3. 172.28.0.111目前已经部署的项目有：客服工作台、 知识库、 监控平台
    4. 从目前两台机器到使用情况看（包括cpu、内存等），只用一台进行服务也基本可以满足，因此逐台升级是可行的。

    前置任务：
    1. 监控平台多同时部署到172.28.0.208机器上（监控平台只部署了一台，升级172.28.0.111的时候，监控平台无法访问）。-- wendy跟进处理。
    2. 监控平台和知识库需要参考上面链接文章中的【解决方案1】做下修改，安装依赖的时候就指定node10版本。-- johnny和wendy跟进处理。

    升级步骤：
    1. 修改172.28.0.208机器上3个项目的nginx proxy_pass属性，分别代理到172.28.0.111对应的端口上。
        -- 工作台修改：cs_workspace.conf文件
        -- 知识库修改：cs_workspace.conf文件
        -- 监控平台修改：workspace_monitor_new.conf文件
    2. 确认172.28.0.208上面的node项目不在接收请求。
    3. 通过cmdb]升级172.28.0.208这台机器的node版本到node10（如果升级失败，可尝试先执行node卸载程序）。
    4. 升级完成之后，通过ip直接访问访问172.28.0.208，验证升级之后程序运行是否正常。
    5. 正常之后，清理项目日志（/data/log/nodejs/log/），防止日志分片工具处理过大到历史日志。
    6. 修改172.28.0.208机器上3个项目的nginx proxy_pass属性，改回原来的配置即可。

    至此，完成一台机器到升级；然后操作另一台机器；

    1. 修改172.28.0.111机器上3个项目的nginx proxy_pass属性，分别代理到172.28.0.208对应的端口上。
    2. 确认172.28.0.111上面的node项目不在接收请求。
    3. 通过cmdb]升级172.28.0.111这台机器的node版本到node10（如果升级失败，可尝试先执行node卸载程序）。
    4. 升级完成，通过ip直接访问172.28.0.111，验证升级之后程序运行是否正常。
    5. 正常之后，清理项目日志（/data/log/nodejs/log/），防止日志分片工具处理过大到历史日志。
    6. 修改172.28.0.111机器上3个项目的nginx proxy_pass属性，改回原来的配置即可。

    两台机器都成功升级之后：
    1. 通过walle重新部署3个项目（部署之前，需要对项目做一些修改，新增node版本依赖包，修改walle发布配置），发布完成验证程序是否正常。

# 后记

&emsp;&emsp;1. 机器上的node升级完成之后，需要发布最新的代码到机器上去验证；但由于只升级了一台机器，所以这里需要改一下walle发布配置，只发布到已经升级完成到那台机器上；发布完成之后，用ip验证程序是否正常（这里不能用之前到端口和域名，因为已经被代理到另外一台机器上了，可以自己新加一个测试域名，本地配上host进行测试）。

&emsp;&emsp;2. 上一步验证OK后，恢复升级完成到机器到流量，观察一段时间（比如等一个小时左右），一切都没问题，再升级另一台机器。

# 最后
&emsp;&emsp;至此，完成两台服务器上node版本的平滑升级。


